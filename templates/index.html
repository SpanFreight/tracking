{% extends "layout.html" %}

{% block content %}
<h1 class="mb-4">Container Tracking Dashboard</h1>

<!-- Add custom CSS for equal width cards -->
<style>
    @media (min-width: 992px) {
        .col-lg-fifth {
            flex: 0 0 20%;
            max-width: 20%;
        }
    }
</style>

<div class="row mb-4">
    <div class="col-md-4 col-lg-fifth mb-2 mb-lg-0">
        <div class="card bg-primary text-white h-100">
            <div class="card-body">
                <h5 class="card-title">Total Containers</h5>
                <h2 class="card-text">{{ total_container_count }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-4 col-lg-fifth mb-2 mb-lg-0">
        <div class="card bg-success text-white h-100">
            <div class="card-body">
                <h5 class="card-title">Loaded Containers</h5>
                <h2 class="card-text">{{ total_loaded_count }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-4 col-lg-fifth mb-2 mb-lg-0">
        <div class="card bg-warning text-dark h-100">
            <div class="card-body">
                <h5 class="card-title">Discharged Containers</h5>
                <h2 class="card-text">{{ total_discharged_count }}</h2>
            </div>
        </div>
    </div>
    <!-- New card for Emptied Containers -->
    <div class="col-md-4 col-lg-fifth mb-2 mb-lg-0">
        <div class="card bg-info text-white h-100">
            <div class="card-body">
                <h5 class="card-title">Emptied Containers</h5>
                <h2 class="card-text">{{ total_emptied_count|default(0) }}</h2>
            </div>
        </div>
    </div>
    <!-- New card for Full Containers -->
    <div class="col-md-4 col-lg-fifth mb-2 mb-lg-0">
        <div class="card bg-primary text-white h-100" style="background-color: #7952B3 !important;">
            <div class="card-body">
                <h5 class="card-title">Full Containers</h5>
                <h2 class="card-text">{{ total_full_count|default(0) }}</h2>
            </div>
        </div>
    </div>
</div>

<!-- Location Filter Navigation - Placed BEFORE the table -->
<div class="card mb-4">
    <div class="card-header bg-light">
        <h5 class="mb-0">Filter by Location</h5>
    </div>
    <div class="card-body">
        <ul class="nav nav-pills">
            {% for location in standard_locations %}
                <li class="nav-item">
                    <a class="nav-link {% if location_filter == location %}active{% endif %}" 
                       href="{{ url_for('index', location=location) }}">
                       {{ location }} 
                       <span class="badge bg-secondary">{{ location_counts.get(location, 0) }}</span>
                    </a>
                </li>
            {% endfor %}
            
            <!-- Dropdown for "Other" locations -->
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle {% if location_filter not in standard_locations %}active{% endif %}" 
                   data-bs-toggle="dropdown" href="#" role="button" aria-expanded="false">
                   Other Locations
                </a>
                <ul class="dropdown-menu">
                    {% for location in other_locations %}
                        <li>
                            <a class="dropdown-item {% if location_filter == location %}active{% endif %}" 
                               href="{{ url_for('index', location=location) }}">
                               {{ location }} 
                               <span class="badge bg-secondary">{{ location_counts.get(location, 0) }}</span>
                            </a>
                        </li>
                    {% endfor %}
                    {% if other_locations|length == 0 %}
                        <li><span class="dropdown-item disabled">No other locations</span></li>
                    {% endif %}
                </ul>
            </li>
        </ul>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
        <div class="d-flex align-items-center">
            <h5 class="mb-0 me-3">Container List</h5>
            <div class="btn-group" role="group" aria-label="Sort Options">
                <a href="{{ url_for('index', location=location_filter, sort='container_number', order='asc' if sort_by == 'container_number' and sort_order == 'desc' else 'desc') }}" 
                   class="btn {{ 'btn-dark' if sort_by == 'container_number' else 'btn-outline-dark' }} d-flex align-items-center">
                    <span class="me-1">Number</span>
                    <i class="fas fa-sort-{{ 'up' if sort_by == 'container_number' and sort_order == 'asc' else 'down' }} ms-1"></i>
                </a>
                <a href="{{ url_for('index', location=location_filter, sort='container_type', order='asc' if sort_by == 'container_type' and sort_order == 'desc' else 'desc') }}" 
                   class="btn {{ 'btn-dark' if sort_by == 'container_type' else 'btn-outline-dark' }} d-flex align-items-center">
                    <span class="me-1">Type</span>
                    <i class="fas fa-sort-{{ 'up' if sort_by == 'container_type' and sort_order == 'asc' else 'down' }} ms-1"></i>
                </a>
                <a href="{{ url_for('index', location=location_filter, sort='status', order='asc' if sort_by == 'status' and sort_order == 'desc' else 'desc') }}" 
                   class="btn {{ 'btn-dark' if sort_by == 'status' else 'btn-outline-dark' }} d-flex align-items-center">
                    <span class="me-1">Status</span>
                    <i class="fas fa-sort-{{ 'up' if sort_by == 'status' and sort_order == 'asc' else 'down' }} ms-1"></i>
                </a>
                <!-- Add a new sort option for Arrival Date -->
                <a href="{{ url_for('index', location=location_filter, sort='arrival_date', order='asc' if sort_by == 'arrival_date' and sort_order == 'desc' else 'desc') }}" 
                   class="btn {{ 'btn-dark' if sort_by == 'arrival_date' else 'btn-outline-dark' }} d-flex align-items-center">
                    <span class="me-1">Date</span>
                    <i class="fas fa-sort-{{ 'up' if sort_by == 'arrival_date' and sort_order == 'asc' else 'down' }} ms-1"></i>
                </a>
            </div>
        </div>
        <div class="d-flex gap-2 mt-2 mt-md-0">
            <div class="btn-group me-2" id="status-filter-buttons">
                <a href="{{ url_for('index', location=location_filter, sort=sort_by, order=sort_order) }}" 
                   class="btn btn-outline-primary {% if not status_filter %}active{% endif %}" data-status="all">All</a>
                <a href="{{ url_for('index', status='loaded', location=location_filter, sort=sort_by, order=sort_order) }}" 
                   class="btn btn-outline-success {% if status_filter == 'loaded' %}active{% endif %}" data-status="loaded">Loaded</a>
                <a href="{{ url_for('index', status='discharged', location=location_filter, sort=sort_by, order=sort_order) }}" 
                   class="btn btn-outline-warning {% if status_filter == 'discharged' %}active{% endif %}" data-status="discharged">Discharged</a>
                <a href="{{ url_for('index', status='emptied', location=location_filter, sort=sort_by, order=sort_order) }}" 
                   class="btn btn-outline-info {% if status_filter == 'emptied' %}active{% endif %}" data-status="emptied">Emptied</a>
                <a href="{{ url_for('index', status='full', location=location_filter, sort=sort_by, order=sort_order) }}" 
                   class="btn btn-outline-primary {% if status_filter == 'full' %}active{% endif %}"  data-status="full">Full</a>
                <a href="{{ url_for('index', status='other', location=location_filter, sort=sort_by, order=sort_order) }}" 
                   class="btn btn-outline-secondary {% if status_filter == 'other' %}active{% endif %}"  data-status="other">Other</a>
            </div>
            <form id="global-search-form" action="{{ url_for('index') }}" method="GET" class="d-flex">
                <input type="hidden" name="location" value="{{ location_filter }}">
                <input type="hidden" name="sort" value="{{ sort_by }}">
                <input type="hidden" name="order" value="{{ sort_order }}">
                <!-- Add status filter as a hidden field -->
                <input type="hidden" name="status" value="{{ status_filter }}">
                <input type="text" id="container-search" name="search" class="form-control" 
                       placeholder="Search containers..." value="{{ request.args.get('search', '') }}">
                <button type="submit" class="btn btn-primary ms-2">
                    <i class="fas fa-search"></i>
                </button>
            </form>
        </div>
    </div>
    <div class="card-body">
        <div id="status-filter-badge" class="mb-3" style="display: {% if status_filter %}block{% else %}none{% endif %};">
            <span class="badge bg-primary">Filtered by: <span id="current-filter">{{ status_filter|capitalize if status_filter else 'All' }}</span></span>
            <button class="btn btn-sm btn-outline-secondary ms-2" id="clear-filter">Clear Filter</button>
        </div>
        
        <!-- Bulk actions toolbar - shown when status filter is active and items are selected -->
        <div id="bulk-actions" class="mb-3" style="display: {% if status_filter in ['loaded', 'discharged', 'emptied', 'full', 'other'] %}block{% else %}none{% endif %};">
            <div class="d-flex flex-wrap align-items-center">
                <div class="me-2">
                    <button type="button" id="select-all" class="btn btn-sm btn-outline-primary">Select All</button>
                    <button type="button" id="deselect-all" class="btn btn-sm btn-outline-secondary">Deselect All</button>
                </div>
                <div class="me-2">
                    <span id="selected-count" class="badge bg-info">0 containers selected</span>
                </div>
                <div class="ms-auto">
                    <!-- Show different buttons based on the filter -->
                    <button type="button" id="bulk-load-btn" class="btn btn-success bulk-action-btn" 
                            style="display: {% if status_filter in ['discharged', 'emptied', 'full'] %}inline-block{% else %}none{% endif %};">
                        <i class="fas fa-ship"></i> Load Selected Containers
                    </button>
                    <button type="button" id="bulk-discharge-btn" class="btn btn-warning bulk-action-btn"
                            style="display: {% if status_filter == 'loaded' %}inline-block{% else %}none{% endif %};">
                        <i class="fas fa-anchor"></i> Discharge Selected Containers
                    </button>
                    <button type="button" id="bulk-emptied-btn" class="btn btn-info bulk-action-btn"
                            style="display: {% if status_filter in ['discharged', 'full'] %}inline-block{% else %}none{% endif %};">
                        <i class="fas fa-box-open"></i> Mark as Emptied
                    </button>
                    <button type="button" id="bulk-full-btn" class="btn btn-primary bulk-action-btn"
                            style="display: {% if status_filter == 'emptied' %}inline-block{% else %}none{% endif %};">
                        <i class="fas fa-box"></i> Mark as Full
                    </button>
                    <!-- New button for marking full containers as delivered to customer -->
                    <button type="button" id="bulk-full-delivered-btn" class="btn btn-danger bulk-action-btn"
                            style="display: {% if status_filter == 'full' %}inline-block{% else %}none{% endif %};">
                        <i class="fas fa-truck"></i> Mark as Delivery to Customer
                    </button>
                    <!-- New button for emptying "other" status containers -->
                    <button type="button" id="bulk-other-to-emptied-btn" class="btn btn-info bulk-action-btn"
                            style="display: {% if status_filter == 'other' %}inline-block{% else %}none{% endif %};">
                        <i class="fas fa-box-open"></i> Empty Selected Containers
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Add this after your existing status filter buttons, but before the container list -->
        {% if status_filter == 'full' %}
        <div class="mb-3">
            <div class="d-flex justify-content-end">
                <div class="d-flex align-items-center gap-2">
                    <span class="badge bg-info"><i class="fas fa-filter me-1"></i> Full Filter:</span>
                    <div class="btn-group btn-group-sm">
                        <a href="{{ url_for('index', location=location_filter, status='full', full_type='all', sort=sort_by, order=sort_order, search=request.args.get('search', '')) }}" 
                           class="btn {% if request.args.get('full_type', 'all') == 'all' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                            All
                        </a>
                        <a href="{{ url_for('index', location=location_filter, status='full', full_type='full_only', sort=sort_by, order=sort_order, search=request.args.get('search', '')) }}" 
                           class="btn {% if request.args.get('full_type') == 'full_only' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                            Full Only
                        </a>
                        <a href="{{ url_for('index', location=location_filter, status='full', full_type='full_deliveried', sort=sort_by, order=sort_order, search=request.args.get('search', '')) }}" 
                           class="btn {% if request.args.get('full_type') == 'full_deliveried' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                            Deliveried
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th class="select-column" style="display: {% if status_filter in ['loaded', 'discharged', 'emptied', 'full', 'other'] %}table-cell{% else %}none{% endif %};">
                            <input type="checkbox" id="select-all-checkbox">
                        </th>
                        <th>Container Number</th>
                        <th>Type</th>
                        <th>Loading Port</th>
                        <th>Vessel</th>
                        <th>Final Dest</th>
                        <th>OPR</th>
                        <th>Current Status</th>
                        <th>Arrival Date</th>
                        <th>Stripping Date</th>
                        <th>Days</th>
                        <th>BL NUMBER</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="container-list">
                    {% for container in containers %}
                    {% set latest_status = container.get_current_status() %}
                    {% set current_location = container.get_current_location() %}
                    {% set discharge_date = None %}
                    {% set today = now.date() %}
                    
                    {% for movement in container.movements|sort(attribute='operation_date', reverse=true) %}
                        {% if movement.operation_type == 'discharge' and not discharge_date %}
                            {% set discharge_date = movement.operation_date.date() %}
                        {% endif %}
                    {% endfor %}
                    
                    <tr data-status="{{ latest_status.status if latest_status else 'not-set' }}" data-id="{{ container.id }}">
                        <td class="select-column" style="display: {% if status_filter in ['loaded', 'discharged', 'emptied', 'full', 'other'] %}table-cell{% else %}none{% endif %};">
                            <input type="checkbox" class="container-select" data-container-id="{{ container.id }}" data-id="{{ container.id }}" data-number="{{ container.container_number }}">
                        </td>
                        <td>{{ container.container_number }}</td>
                        <td>{{ container.container_type }}</td>
                        <td>{{ container.loading_port if container.loading_port else '-' }}</td>
                        <td>
                            {% if container.get_current_vessel() %}
                                <a href="{{ url_for('vessel_detail', id=container.get_current_vessel().id) }}">
                                    {{ container.get_current_vessel().name }}
                                </a>
                            {% elif container.get_current_status() and container.get_current_status().status == 'discharged' %}
                                {% set last_vessel = container.get_last_vessel() %}
                                {% if last_vessel %}
                                    <span title="Previously on this vessel">
                                        <i class="fas fa-ship text-muted"></i>
                                        <a href="{{ url_for('vessel_detail', id=last_vessel.id) }}" class="text-muted">
                                            {{ last_vessel.name }}
                                        </a>
                                    </span>
                                {% else %}
                                    -
                                {% endif %}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>{{ container.final_destination if container.final_destination else '-' }}</td>
                        <td>{{ container.opr if container.opr else '-' }}</td>
                        <td>
                            {% if latest_status %}
                                {% if latest_status.status == 'loaded' %}
                                <span class="badge bg-success">Loaded</span>
                                {% elif latest_status.status == 'discharged' %}
                                <span class="badge bg-warning text-dark">Discharged</span>
                                {% elif latest_status.status == 'emptied' %}
                                <span class="badge bg-info">Emptied</span>
                                {% elif latest_status.status == 'full' %}
                                <span class="badge bg-primary">Full</span>
                                {% elif latest_status.status == 'full_deliveried' %}
                                <span class="badge bg-purple" style="background-color: #9370DB;">Full Deliveried</span>
                                {% else %}
                                <span class="badge bg-secondary">{{ latest_status.status }}</span>
                                {% endif %}
                            {% else %}
                                <span class="badge bg-secondary">Not Set</span>
                            {% endif %}
                        </td>
                        <td>
                            {{ container.arrival_date.strftime('%Y-%m-%d') if container.arrival_date else 'N/A' }}
                        </td>
                        <td>
                            {{ container.stripping_date.strftime('%Y-%m-%d') if container.stripping_date else 'N/A' }}
                        </td>
                        <td>
                            {% if container.stripping_date and container.arrival_date %}
                                {{ (container.stripping_date.date() - container.arrival_date.date()).days }}
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                        <td>{{ container.bl_number if container.bl_number else 'N/A' }}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <a href="{{ url_for('container_detail', id=container.id) }}" class="btn btn-sm btn-primary">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a href="{{ url_for('update_status', id=container.id) }}" class="btn btn-sm btn-success">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal{{ container.id }}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            
                            <!-- Delete Modal for each container -->
                            <div class="modal fade" id="deleteModal{{ container.id }}" tabindex="-1" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header bg-danger text-white">
                                            <h5 class="modal-title">Confirm Delete</h5>
                                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <p>Are you sure you want to delete container <strong>{{ container.container_number }}</strong>?</p>
                                            <p class="text-danger">This action cannot be undone.</p>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                            <form action="{{ url_for('delete_container', id=container.id) }}" method="POST">
                                                <button type="submit" class="btn btn-danger">Delete</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Centered pagination controls -->
        {% if pagination.pages > 1 %}
          {% include 'includes/pagination.html' %}
        {% endif %}
    </div>
</div>

<!-- Modal for Bulk Container Loading -->
<div class="modal fade" id="bulkLoadModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Bulk Load Containers</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="bulk-load-form">
                    <div class="mb-3">
                        <label for="bulk-vessel-select" class="form-label">Select Vessel</label>
                        <select class="form-select" id="bulk-vessel-select" required>
                            <option value="">-- Select a vessel --</option>
                            <!-- Vessels will be populated via AJAX to exclude departed vessels -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="bulk-operation-date" class="form-label">Operation Date</label>
                        <input type="date" class="form-control" id="bulk-operation-date" required 
                               value="{{ now.strftime('%Y-%m-%d') }}">
                    </div>
                    <div class="mb-3">
                        <label for="bulk-location" class="form-label">Location</label>
                        <input type="text" class="form-control" id="bulk-location" required>
                    </div>
                    <div class="mb-3">
                        <label for="bulk-notes" class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" id="bulk-notes" rows="3"></textarea>
                    </div>
                    <div class="alert alert-info">
                        <h6>Selected Containers (<span id="modal-selected-count">0</span>):</h6>
                        <ul id="selected-containers-list" class="mb-0"></ul>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirm-bulk-load">Confirm Loading</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Bulk Container Discharge -->
<div class="modal fade" id="bulkDischargeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">Bulk Discharge Containers</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="bulk-discharge-form">
                    <input type="hidden" id="bulk-discharge-vessel-id">
                    <div class="mb-3">
                        <label class="form-label">Vessel Information</label>
                        <div class="alert alert-info" id="bulk-discharge-vessel-info">
                            Loading vessel information...
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="bulk-discharge-date" class="form-label">Operation Date</label>
                        <input type="date" class="form-control" id="bulk-discharge-date" required 
                               value="{{ now.strftime('%Y-%m-%d') }}">
                    </div>
                    <div class="mb-3">
                        <label for="bulk-discharge-location" class="form-label">Location</label>
                        <input type="text" class="form-control" id="bulk-discharge-location" required>
                    </div>
                    <div class="mb-3">
                        <label for="bulk-discharge-notes" class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" id="bulk-discharge-notes" rows="3"></textarea>
                    </div>
                    <div class="alert alert-info">
                        <h6>Selected Containers (<span id="modal-discharge-count">0</span>):</h6>
                        <ul id="selected-discharge-containers-list" class="mb-0"></ul>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="confirm-bulk-discharge">Confirm Discharge</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Modal for Bulk Status Change to Emptied -->
<div class="modal fade" id="bulkEmptiedModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">Mark Containers as Emptied</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="bulk-emptied-form">
                    <div class="mb-3">
                        <label for="bulk-emptied-date" class="form-label">Operation Date</label>
                        <input type="date" class="form-control" id="bulk-emptied-date" required 
                               value="{{ now.strftime('%Y-%m-%d') }}">
                    </div>
                    <div class="mb-3">
                        <label for="bulk-emptied-location" class="form-label">Location</label>
                        <input type="text" class="form-control" id="bulk-emptied-location" required>
                    </div>
                    <div class="mb-3">
                        <label for="bulk-emptied-notes" class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" id="bulk-emptied-notes" rows="3">Empty Container</textarea>
                    </div>
                    <div class="alert alert-info">
                        <h6>Selected Containers (<span id="modal-emptied-count">0</span>):</h6>
                        <ul id="selected-emptied-containers-list" class="mb-0"></ul>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-info" id="confirm-bulk-emptied">Confirm Update</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Modal for Bulk Status Change to Full -->
<div class="modal fade" id="bulkFullModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Mark Containers as Full</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="bulk-full-form">
                    <div class="mb-3">
                        <label for="bulk-full-date" class="form-label">Operation Date</label>
                        <input type="date" class="form-control" id="bulk-full-date" required 
                               value="{{ now.strftime('%Y-%m-%d') }}">
                    </div>
                    <div class="mb-3">
                        <label for="bulk-full-location" class="form-label">Location</label>
                        <input type="text" class="form-control" id="bulk-full-location" required>
                    </div>
                    <div class="mb-3">
                        <label for="bulk-full-notes" class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" id="bulk-full-notes" rows="3">Full Container</textarea>
                    </div>
                    <div class="alert alert-info">
                        <h6>Selected Containers (<span id="modal-full-count">0</span>):</h6>
                        <ul id="selected-full-containers-list" class="mb-0"></ul>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirm-bulk-full">Confirm Update</button>
            </div>
        </div>
    </div>
</div>

<!-- Add a new modal for emptying "other" status containers -->
<div class="modal fade" id="bulkOtherToEmptiedModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">Empty Selected "Other" Status Containers</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="bulk-other-to-emptied-form">
                    <div class="mb-3">
                        <label for="bulk-other-to-emptied-date" class="form-label">Operation Date</label>
                        <input type="date" class="form-control" id="bulk-other-to-emptied-date" required 
                               value="{{ now.strftime('%Y-%m-%d') }}">
                    </div>
                    <div class="mb-3">
                        <label for="bulk-other-to-emptied-location" class="form-label">Location</label>
                        <input type="text" class="form-control" id="bulk-other-to-emptied-location" required>
                    </div>
                    <div class="mb-3">
                        <label for="bulk-other-to-emptied-notes" class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" id="bulk-other-to-emptied-notes" rows="3">Empty Container</textarea>
                    </div>
                    <div class="alert alert-info">
                        <h6>Selected Containers (<span id="modal-other-to-emptied-count">0</span>):</h6>
                        <ul id="selected-other-to-emptied-containers-list" class="mb-0"></ul>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-info" id="confirm-bulk-other-to-emptied">Confirm Update</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Modal for Marking as Delivered to Customer -->
<div class="modal fade" id="bulkFullDeliveredModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Mark Containers as Delivery to Customer</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="bulk-full-delivered-form">
                    <div class="mb-3">
                        <label for="bulk-full-delivered-date" class="form-label">Operation Date</label>
                        <input type="date" class="form-control" id="bulk-full-delivered-date" required 
                               value="{{ now.strftime('%Y-%m-%d') }}">
                    </div>
                    <div class="mb-3">
                        <label for="bulk-full-delivered-location" class="form-label">Location</label>
                        <input type="text" class="form-control" id="bulk-full-delivered-location" required>
                    </div>
                    <div class="mb-3">
                        <label for="bulk-full-delivered-notes" class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" id="bulk-full-delivered-notes" rows="3">Container delivered to customer</textarea>
                    </div>
                    <div class="alert alert-info">
                        <h6>Selected Containers (<span id="modal-full-delivered-count">0</span>):</h6>
                        <ul id="selected-full-delivered-containers-list" class="mb-0"></ul>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-bulk-full-delivered">Confirm Delivery</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // Initialize container selection persistence
        const containerSelections = {
            storageKey: 'selectedContainers',
            
            // Get all selected container IDs from localStorage
            getSelectedIds: function() {
                const stored = localStorage.getItem(this.storageKey);
                return stored ? JSON.parse(stored) : [];
            },
            
            // Save a container ID to localStorage
            addId: function(id) {
                const ids = this.getSelectedIds();
                if (!ids.includes(id)) {
                    ids.push(id);
                    localStorage.setItem(this.storageKey, JSON.stringify(ids));
                }
            },
            
            // Remove a container ID from localStorage
            removeId: function(id) {
                const ids = this.getSelectedIds();
                const index = ids.indexOf(id);
                if (index > -1) {
                    ids.splice(index, 1);
                    localStorage.setItem(this.storageKey, JSON.stringify(ids));
                }
            },
            
            // Clear all selections from localStorage
            clearAll: function() {
                localStorage.removeItem(this.storageKey);
            },
            
            // Apply stored selections to checkboxes on page
            applySelections: function() {
                const selectedIds = this.getSelectedIds();
                $('.container-select').each(function() {
                    const id = $(this).data('id').toString();
                    $(this).prop('checked', selectedIds.includes(id));
                });
                updateSelectedCount(); // Update the counter after applying selections
            }
        };
        
        // Apply stored selections when page loads
        containerSelections.applySelections();
        
        // Update dashboard counts - modified to exclude containers on departed vessels
        function updateDashboardCounts() {
            $.get('/api/containers', function(data) {
                let loaded = 0;
                let discharged = 0;
                let emptied = 0;
                let full = 0;
                let total = 0;
                
                data.forEach(container => {
                    // Skip containers on departed vessels
                    if (container.on_departed_vessel === true) {
                        return; // Skip this container
                    }
                    
                    // Count this container in the total
                    total++;
                    
                    // Count by status
                    if (container.current_status === 'loaded') loaded++;
                    if (container.current_status === 'discharged') discharged++;
                    if (container.current_status === 'emptied') emptied++;
                    if (container.current_status === 'full') full++;
                });
                
                // Update the card text values with filtered counts
                $('.card-body:contains("Total Containers")').find('.card-text').text(total);
                $('.card-body:contains("Loaded")').find('.card-text').text(loaded);
                $('.card-body:contains("Discharged")').find('.card-text').text(discharged);
                $('.card-body:contains("Emptied")').find('.card-text').text(emptied);
                $('.card-body:contains("Full")').find('.card-text').text(full);
            });
        }
        
        // Container search functionality
        $('#container-search').on('keyup', function(e) {
            if (e.keyCode === 13) {  // Enter key
                $('#global-search-form').submit();
                return;
            }
            // Keep the local filtering for immediate feedback
            filterContainers();
        });
        
        // Status filter functionality
        let currentStatusFilter = "{{ status_filter|default('all', true) }}";
        
        // Add click handlers to status filter buttons
        $('#status-filter-buttons a').on('click', function(e) {
            // Don't do anything here, just let the link work normally
            // The server-side will handle the filtering
        });
        
        $('#clear-filter').on('click', function() {
            window.location.href = "{{ url_for('index', location=location_filter) }}";
        });
        
        // Bulk selection functionality
        $('#select-all').click(function() {
            $('.container-select:visible').each(function() {
                $(this).prop('checked', true);
                const id = $(this).data('id').toString();
                containerSelections.addId(id);
            });
            updateSelectedCount();
        });
        
        $('#deselect-all').click(function() {
            containerSelections.clearAll();
            $('.container-select').prop('checked', false);
            updateSelectedCount();
        });
        
        $('#select-all-checkbox').change(function() {
            $('.container-select:visible').each(function() {
                $(this).prop('checked', this.checked);
                const id = $(this).data('id').toString();
                if ($('#select-all-checkbox').is(':checked')) {
                    containerSelections.addId(id);
                } else {
                    containerSelections.removeId(id);
                }
            });
            updateSelectedCount();
        });
        
        // Update when individual checkboxes change
        $(document).on('change', '.container-select', function() {
            const id = $(this).data('id').toString();
            if ($(this).is(':checked')) {
                containerSelections.addId(id);
            } else {
                containerSelections.removeId(id);
            }
            updateSelectedCount();
        });
        
        function updateSelectedCount() {
            // Get the count from localStorage instead of just visible checkboxes
            const selectedCount = containerSelections.getSelectedIds().length;
            $('#selected-count').text(selectedCount + ' containers selected');
            
            // Update containers list in all modals
            updateModalContainersList('selected-containers-list', 'modal-selected-count');
            updateModalContainersList('selected-discharge-containers-list', 'modal-discharge-count');
            updateModalContainersList('selected-emptied-containers-list', 'modal-emptied-count');
            updateModalContainersList('selected-full-containers-list', 'modal-full-count');
            updateModalContainersList('selected-other-to-emptied-containers-list', 'modal-other-to-emptied-count');
            // Add the new modal list update
            updateModalContainersList('selected-full-delivered-containers-list', 'modal-full-delivered-count');
            
            // Enable/disable bulk action buttons based on selection
            $('.bulk-action-btn').prop('disabled', selectedCount === 0);
        }
        
        function updateModalContainersList(listId, countId) {
            const $list = $('#' + listId).empty();
            const selectedIds = containerSelections.getSelectedIds();
            let containerNumbers = [];
            
            // For each selected ID, find the container number if visible
            selectedIds.forEach(id => {
                const $checkbox = $(`.container-select[data-id="${id}"]`);
                if ($checkbox.length) {
                    containerNumbers.push($checkbox.data('number'));
                } else {
                    // For containers not visible on current page, just show the ID
                    containerNumbers.push(`Container #${id}`);
                }
            });
            
            // Add container numbers to the list
            containerNumbers.forEach(number => {
                $list.append(`<li>${number}</li>`);
            });
            
            // Update the count
            $('#' + countId).text(selectedIds.length);
        }
        
        function filterContainers() {
            const searchValue = $('#container-search').val().toLowerCase();
            
            $('#container-list tr').each(function() {
                const $row = $(this);
                const rowText = $row.text().toLowerCase();
                const hasSearchMatch = rowText.indexOf(searchValue) > -1;
                
                // Get the status from the data-status attribute
                const status = $row.data('status');
                
                let statusMatch = true;
                if (currentStatusFilter !== 'all' && currentStatusFilter) {
                    statusMatch = status === currentStatusFilter;
                }
                
                $row.toggle(hasSearchMatch && statusMatch);
            });
            
            // Update the "no results" message
            if ($('#container-list tr:visible').length === 0) {
                if ($('#no-results-message').length === 0) {
                    $('#container-list').after('<div id="no-results-message" class="alert alert-info mt-3">No containers match your search criteria. Try broadening your search or <a href="{{ url_for("index", location=location_filter) }}">clear the search</a>.</div>');
                }
            } else {
                $('#no-results-message').remove();
            }
        }
        
        // Bulk operations modal handlers
        $('#bulk-load-btn').click(function() {
            loadAvailableVessels();
            $('#bulkLoadModal').modal('show');
        });
        
        $('#bulk-discharge-btn').click(function() {
            prepareDischargeModal();
        });
        
        $('#bulk-emptied-btn').click(function() {
            prepareStatusModal('emptied', 'bulkEmptiedModal');
        });
        
        $('#bulk-full-btn').click(function() {
            prepareStatusModal('full', 'bulkFullModal');
        });
        
        // Add the new modal handler
        $('#bulk-other-to-emptied-btn').click(function() {
            prepareStatusModal('emptied', 'bulkOtherToEmptiedModal');
        });
        
        // Add handler for the new Full Delivered button
        $('#bulk-full-delivered-btn').click(function() {
            prepareFullDeliveredModal();
        });
        
        function loadAvailableVessels() {
            $.ajax({
                url: '/api/vessels/available',
                type: 'GET',
                success: function(vessels) {
                    const $select = $('#bulk-vessel-select').empty();
                    $select.append('<option value="">-- Select a vessel --</option>');
                    
                    if (vessels.length === 0) {
                        $select.append('<option disabled>No vessels available for loading</option>');
                    } else {
                        vessels.forEach(vessel => {
                            $select.append(`<option value="${vessel.id}">${vessel.name} (Voy NÂ°: ${vessel.imo_number})</option>`);
                        });
                    }
                    
                    // Pre-fill location with current filter
                    $('#bulk-location').val("{{ location_filter }}");
                },
                error: function(xhr) {
                    alert('Error loading vessels: ' + xhr.responseText);
                }
            });
        }
        
        function prepareDischargeModal() {
            const containerIds = getSelectedContainerIds();
            if (containerIds.length === 0) {
                alert('Please select at least one container');
                return;
            }
            
            // Get vessel info from the first container
            $.ajax({
                url: '/api/container/' + containerIds[0] + '/vessel',
                type: 'GET',
                success: function(response) {
                    if (response.success) {
                        $('#bulk-discharge-vessel-id').val(response.vessel_id);
                        $('#bulk-discharge-vessel-info').html(`
                            <strong>Vessel:</strong> ${response.vessel_name}<br>
                            <strong>Current Location:</strong> ${response.vessel_location || 'Not specified'}
                        `);
                        $('#bulk-discharge-location').val(response.vessel_location || "{{ location_filter }}");
                        $('#bulkDischargeModal').modal('show');
                    } else {
                        alert('Error: Selected containers are not on a vessel');
                    }
                },
                error: function(xhr) {
                    alert('Error: ' + (xhr.responseJSON ? xhr.responseJSON.error : 'Could not retrieve vessel information'));
                }
            });
        }
        
        function prepareStatusModal(status, modalId) {
            if (getSelectedContainerIds().length === 0) {
                alert('Please select at least one container');
                return;
            }
            
            // Pre-fill location with current filter
            $(`#bulk-${status}-location`).val("{{ location_filter }}");
            $(`#${modalId}`).modal('show');
        }
        
        // New function specifically for preparing the Full Delivered modal
        function prepareFullDeliveredModal() {
            const selectedIds = getSelectedContainerIds();
            if (selectedIds.length === 0) {
                alert('Please select at least one container');
                return;
            }
            
            // Get the first selected container's ID to fetch its location
            const firstContainerId = selectedIds[0];
            
            // Use AJAX to get the container's current location
            $.ajax({
                url: `/api/container/${firstContainerId}/location`,
                type: 'GET',
                success: function(response) {
                    if (response.success) {
                        // Set the location field to the container's current location
                        $('#bulk-full-delivered-location').val(response.location || "{{ location_filter }}");
                    } else {
                        // Fallback to using the current filter location
                        $('#bulk-full-delivered-location').val("{{ location_filter }}");
                    }
                    
                    // Show the modal after setting the location
                    $('#bulkFullDeliveredModal').modal('show');
                },
                error: function() {
                    // On error, fallback to the location filter
                    $('#bulk-full-delivered-location').val("{{ location_filter }}");
                    $('#bulkFullDeliveredModal').modal('show');
                }
            });
        }
        
        function getSelectedContainerIds() {
            return containerSelections.getSelectedIds();
        }
        
        // Handle form submissions for bulk operations
        $('#confirm-bulk-load').click(handleBulkLoad);
        $('#confirm-bulk-discharge').click(handleBulkDischarge);
        $('#confirm-bulk-emptied').click(function() { handleBulkStatus('emptied'); });
        $('#confirm-bulk-full').click(function() { handleBulkStatus('full'); });
        
        // Add handler for new "Empty Other Containers" button
        $('#confirm-bulk-other-to-emptied').click(function() {
            const date = $('#bulk-other-to-emptied-date').val();
            const location = $('#bulk-other-to-emptied-location').val();
            const notes = $('#bulk-other-to-emptied-notes').val();
            
            if (!date || !location) {
                alert('Please fill in all required fields');
                return;
            }
            
            performBulkOperation('/containers/bulk-status-update', {
                container_ids: getSelectedContainerIds(),
                status: 'emptied',
                date: date,
                location: location,
                notes: notes
            }, 'bulkOtherToEmptiedModal');
        });
        
        // Add handler for Full Delivered button
        $('#confirm-bulk-full-delivered').click(function() {
            const date = $('#bulk-full-delivered-date').val();
            const location = $('#bulk-full-delivered-location').val();
            const notes = $('#bulk-full-delivered-notes').val();
            
            if (!date || !location) {
                alert('Please fill in all required fields');
                return;
            }
            
            performBulkOperation('/containers/bulk-status-update', {
                container_ids: getSelectedContainerIds(),
                status: 'full_deliveried',
                date: date,
                location: location,
                notes: notes || 'Container delivered to customer'
            }, 'bulkFullDeliveredModal');
        });
        
        function handleBulkLoad() {
            const vesselId = $('#bulk-vessel-select').val();
            const date = $('#bulk-operation-date').val();
            const location = $('#bulk-location').val();
            const notes = $('#bulk-notes').val();
            
            if (!vesselId || !date || !location) {
                alert('Please fill in all required fields');
                return;
            }
            
            performBulkOperation('/containers/bulk-load', {
                container_ids: getSelectedContainerIds(),
                vessel_id: vesselId,
                operation_date: date,
                location: location,
                notes: notes
            }, 'bulkLoadModal');
        }
        
        function handleBulkDischarge() {
            const vesselId = $('#bulk-discharge-vessel-id').val();
            const date = $('#bulk-discharge-date').val();
            const location = $('#bulk-discharge-location').val();
            const notes = $('#bulk-discharge-notes').val();
            
            if (!vesselId || !date || !location) {
                alert('Please fill in all required fields');
                return;
            }
            
            performBulkOperation('/containers/bulk-discharge', {
                container_ids: getSelectedContainerIds(),
                vessel_id: vesselId,
                operation_date: date,
                location: location,
                notes: notes
            }, 'bulkDischargeModal');
        }
        
        function handleBulkStatus(status) {
            const date = $(`#bulk-${status}-date`).val();
            const location = $(`#bulk-${status}-location`).val();
            const notes = $(`#bulk-${status}-notes`).val();
            
            if (!date || !location) {
                alert('Please fill in all required fields');
                return;
            }
            
            performBulkOperation('/containers/bulk-status-update', {
                container_ids: getSelectedContainerIds(),
                status: status,
                date: date,
                location: location,
                notes: notes
            }, `bulk${status.charAt(0).toUpperCase() + status.slice(1)}Modal`);
        }
        
        function performBulkOperation(url, data, modalId) {
            $.ajax({
                url: url,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(response) {
                    $(`#${modalId}`).modal('hide');
                    
                    // Clear the container selections from localStorage after successful status change
                    containerSelections.clearAll();
                    
                    alert(response.message || `Operation completed successfully for ${response.success_count} containers!`);
                    window.location.reload();
                },
                error: function(xhr) {
                    const errorMsg = xhr.responseJSON ? xhr.responseJSON.error : 'Operation failed';
                    alert('Error: ' + errorMsg);
                }
            });
        }
        
        // Initialize on page load
        updateDashboardCounts();
        updateSelectedCount();
    });
</script>
{% endblock %}
